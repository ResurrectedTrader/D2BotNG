syntax = "proto3";

package d2bot;

option csharp_namespace = "D2BotNG.Core.Protos";

import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";
import "profiles.proto";
import "keys.proto";
import "schedules.proto";
import "items.proto";
import "settings.proto";
import "updates.proto";
import "logging.proto";

// Message color codes (values match reference implementation)
enum MessageColor {
  COLOR_DEFAULT = 0;  // Black
  // 1-3 reserved (also map to black in reference)
  COLOR_BLUE = 4;
  COLOR_GREEN = 5;
  COLOR_GOLD = 6;     // DarkGoldenrod
  COLOR_BROWN = 7;    // SaddleBrown
  COLOR_ORANGE = 8;   // DarkOrange
  COLOR_RED = 9;
  COLOR_GRAY = 10;
}

// Event streaming service
service EventService {
  // Single event stream for all real-time updates
  rpc StreamEvents(google.protobuf.Empty) returns (stream Event);

  // Clear messages by source
  rpc ClearMessages(ClearMessagesRequest) returns (google.protobuf.Empty);
}

// Request to clear messages for a specific source
message ClearMessagesRequest {
  string source = 1;  // "System" for system messages, or profile name
}

// Main event wrapper with timestamp and typed payload
message Event {
  google.protobuf.Timestamp timestamp = 1;

  oneof event {
    // Snapshots
    ProfilesSnapshot profiles_snapshot = 10;
    KeyListsSnapshot key_lists_snapshot = 11;
    SchedulesSnapshot schedules_snapshot = 12;

    // Profile events
    ProfileState profile_state = 23;

    // Console messages
    Message message = 60;

    // Settings & Updates
    Settings settings = 70;
    UpdateStatus update_status = 71;

    // Item entities
    EntitiesChanged entities_changed = 80;

    // Logging
    LogLevelsSnapshot log_levels_snapshot = 90;
  }
}

// Item entities changed event - signals UI to refresh entity list and search
message EntitiesChanged {}

// Log levels snapshot - sent on connect and when levels change
message LogLevelsSnapshot {
  repeated LogLevelEntry levels = 1;
}

// Snapshot messages
message ProfilesSnapshot {
  repeated ProfileState profiles = 1;
}

message KeyListsSnapshot {
  repeated KeyListWithUsage key_lists = 1;
}

message KeyListWithUsage {
  KeyList key_list = 1;
  repeated KeyUsage usage = 2;
}

message KeyUsage {
  string key_name = 1;
  string profile_name = 2;  // Empty if not in use
}

message SchedulesSnapshot {
  repeated Schedule schedules = 1;
}


// Console message - source is "System" for system messages, or profile name for profile messages
message Message {
  string source = 1;
  string content = 2;
  google.protobuf.Timestamp timestamp = 3;
  MessageColor color = 4;
  optional Item item = 5;
}
